<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—è¨ªè€…å›æ‡‰</title>
    <style>
        body { font-family: 'Noto Sans TC', Arial, sans-serif; margin: 20px; }
        .section { padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .input-group { margin-bottom: 10px; }
        input, textarea { padding: 8px; margin: 5px 0; width: 100%; max-width: 400px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 8px 15px; margin: 5px 0; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .error { color: red; }
        h2 { color: #333; }
        .instructions { font-size: 14px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="section" id="intervieweeSection">
        <h2>ğŸ”’ å€å¡Šéˆå—è¨ªè€…ä»‹é¢</h2>
        <div class="input-group">
            <input id="unitInput" placeholder="å–®ä½">
        </div>
        <div class="input-group">
            <input id="titleInput" placeholder="è·ç¨±">
        </div>
        <div class="input-group">
            <input id="nameInput" placeholder="å§“å">
        </div>
        <div id="interviewDetails" style="display: none;">
            <div class="input-group">
                <input id="interviewTitle" placeholder="æ¡è¨ªæ¨™é¡Œ" readonly>
            </div>
            <div class="input-group">
                <textarea id="question1" placeholder="å•é¡Œä¸€" rows="3" readonly></textarea>
            </div>
            <div class="input-group">
                <textarea id="responseInput" placeholder="è¼¸å…¥æ‚¨çš„å›æ‡‰"></textarea>
            </div>
            <button id="submitResponseButton">æäº¤ä¸å¯ç¯¡æ”¹è¨˜éŒ„</button>
        </div>
        <div id="intervieweeError" class="error"></div>
        <div class="instructions">
            æ“ä½œèªªæ˜ï¼šè¼¸å…¥å–®ä½ã€è·ç¨±å’Œå§“åå¾Œï¼Œå•é¡Œå°‡è‡ªå‹•é¡¯ç¤ºã€‚è«‹åœ¨å›æ‡‰æ¡†ä¸­è¼¸å…¥å…§å®¹ï¼Œé»æ“Šã€Œæäº¤ä¸å¯ç¯¡æ”¹è¨˜éŒ„ã€æŒ‰éˆ•æäº¤ã€‚
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        try {
            // Firebase é…ç½®
            const firebaseConfig = {
                apiKey: "AIzaSyAS1k8LoWuUfD48yW7BaNjr_7HEvj7sVSc",
                authDomain: "reporterapp-1cf28.firebaseapp.com",
                projectId: "reporterapp-1cf28",
                storageBucket: "reporterapp-1cf28.firebasestorage.app",
                messagingSenderId: "226849515931",
                appId: "1:226849515931:web:c0333ba7691ad47f6c193e",
                measurementId: "G-MYWWGDQQRH"
            };

            // åˆå§‹åŒ– Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // å¾ URL ç²å–æ¡è¨ª ID
            const urlParams = new URLSearchParams(window.location.search);
            const interviewId = urlParams.get('interviewId');

            // æ¸…ç©ºéŒ¯èª¤è¨Šæ¯
            function clearErrors() {
                document.getElementById("intervieweeError").innerText = "";
            }

            // è¼‰å…¥æ¡è¨ªç´°ç¯€
            async function loadInterview() {
                clearErrors();
                if (!interviewId) {
                    document.getElementById("intervieweeError").innerText = "ç„¡æ•ˆçš„æ¡è¨ª IDï¼Œè«‹ç¢ºèªé€£çµæ­£ç¢º";
                    return;
                }

                const docRef = doc(db, "interviews", interviewId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const interviewTitle = document.getElementById("interviewTitle");
                    const question1 = document.getElementById("question1");
                    if (interviewTitle && question1) {
                        interviewTitle.value = data.title || "ç„¡æ¨™é¡Œ";
                        question1.value = (data.questions && data.questions.length > 0) ? data.questions[0] : "ç„¡å•é¡Œ";
                        document.getElementById("interviewDetails").style.display = "block";
                    }
                } else {
                    document.getElementById("intervieweeError").innerText = "æ‰¾ä¸åˆ°è©²æ¡è¨ªï¼Œè«‹ç¢ºèª ID æœ‰æ•ˆ";
                }
            }

            // æäº¤å›æ‡‰
            async function submitResponse() {
                clearErrors();
                const unit = document.getElementById("unitInput").value.trim();
                const title = document.getElementById("titleInput").value.trim();
                const name = document.getElementById("nameInput").value.trim();
                const response = document.getElementById("responseInput").value.trim();

                if (!unit || !title || !name || !response) {
                    document.getElementById("intervieweeError").innerText = "è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½";
                    return;
                }

                try {
                    const docRef = doc(db, "interviews", interviewId);
                    const newResponse = {
                        text: response,
                        unit: unit,
                        title: title,
                        name: name,
                        submittedAt: Date.now()
                    };
                    const docSnap = await getDoc(docRef);
                    const currentResponses = docSnap.data()?.responses || [];
                    await updateDoc(docRef, {
                        responses: [...currentResponses, newResponse]
                    });
                    alert("å€å¡Šéˆèªè­‰æˆåŠŸï¼Œå›æ‡‰å·²æäº¤");
                    document.getElementById("responseInput").value = "";
                } catch (error) {
                    console.error("æäº¤å›æ‡‰éŒ¯èª¤:", error);
                    document.getElementById("intervieweeError").innerText = `å€å¡Šéˆè¨˜éŒ„å¤±æ•—: ${error.message}`;
                }
            }

            // åˆå§‹åŒ–
            loadInterview();
            const submitButton = document.getElementById("submitResponseButton");
            if (submitButton) {
                submitButton.addEventListener("click", submitResponse);
            }

        } catch (error) {
            console.error("Firebase SDK è¼‰å…¥å¤±æ•—:", error);
            document.getElementById("intervieweeError").innerText = `ç„¡æ³•è¼‰å…¥ Firebase SDK: ${error.message}`;
        }
    </script>
</body>
</html>
