<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>受訪者回應</title>
    <style>
        body { font-family: 'Noto Sans TC', Arial, sans-serif; margin: 20px; }
        .section { padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .input-group { margin-bottom: 10px; }
        input, textarea { padding: 8px; margin: 5px 0; width: 100%; max-width: 400px; border-radius: 5px; border: 1px solid #ccc; }
        button { padding: 8px 15px; margin: 5px 0; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .error { color: red; }
        h2 { color: #333; }
        .instructions { font-size: 14px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="section" id="intervieweeSection">
        <h2>🔒 區塊鏈受訪者介面</h2>
        <div class="input-group">
            <input id="unitInput" placeholder="單位">
        </div>
        <div class="input-group">
            <input id="titleInput" placeholder="職稱">
        </div>
        <div class="input-group">
            <input id="nameInput" placeholder="姓名">
        </div>
        <div id="interviewDetails" style="display: none;">
            <div class="input-group">
                <input id="interviewTitle" placeholder="採訪標題" readonly>
            </div>
            <div class="input-group">
                <textarea id="question1" placeholder="問題一" rows="3" readonly></textarea>
            </div>
            <div class="input-group">
                <textarea id="responseInput" placeholder="輸入您的回應"></textarea>
            </div>
            <button id="submitResponseButton">提交不可篡改記錄</button>
        </div>
        <div id="intervieweeError" class="error"></div>
        <div class="instructions">
            操作說明：輸入單位、職稱和姓名後，問題將自動顯示。請在回應框中輸入內容，點擊「提交不可篡改記錄」按鈕提交。
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

        try {
            // Firebase 配置
            const firebaseConfig = {
                apiKey: "AIzaSyAS1k8LoWuUfD48yW7BaNjr_7HEvj7sVSc",
                authDomain: "reporterapp-1cf28.firebaseapp.com",
                projectId: "reporterapp-1cf28",
                storageBucket: "reporterapp-1cf28.firebasestorage.app",
                messagingSenderId: "226849515931",
                appId: "1:226849515931:web:c0333ba7691ad47f6c193e",
                measurementId: "G-MYWWGDQQRH"
            };

            // 初始化 Firebase
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // 從 URL 獲取採訪 ID
            const urlParams = new URLSearchParams(window.location.search);
            const interviewId = urlParams.get('interviewId');

            // 清空錯誤訊息
            function clearErrors() {
                document.getElementById("intervieweeError").innerText = "";
            }

            // 載入採訪細節
            async function loadInterview() {
                clearErrors();
                if (!interviewId) {
                    document.getElementById("intervieweeError").innerText = "無效的採訪 ID，請確認連結正確";
                    return;
                }

                const docRef = doc(db, "interviews", interviewId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const interviewTitle = document.getElementById("interviewTitle");
                    const question1 = document.getElementById("question1");
                    if (interviewTitle && question1) {
                        interviewTitle.value = data.title || "無標題";
                        question1.value = (data.questions && data.questions.length > 0) ? data.questions[0] : "無問題";
                        document.getElementById("interviewDetails").style.display = "block";
                    }
                } else {
                    document.getElementById("intervieweeError").innerText = "找不到該採訪，請確認 ID 有效";
                }
            }

            // 提交回應
            async function submitResponse() {
                clearErrors();
                const unit = document.getElementById("unitInput").value.trim();
                const title = document.getElementById("titleInput").value.trim();
                const name = document.getElementById("nameInput").value.trim();
                const response = document.getElementById("responseInput").value.trim();

                if (!unit || !title || !name || !response) {
                    document.getElementById("intervieweeError").innerText = "請填寫所有欄位";
                    return;
                }

                try {
                    const docRef = doc(db, "interviews", interviewId);
                    const newResponse = {
                        text: response,
                        unit: unit,
                        title: title,
                        name: name,
                        submittedAt: Date.now()
                    };
                    const docSnap = await getDoc(docRef);
                    const currentResponses = docSnap.data()?.responses || [];
                    await updateDoc(docRef, {
                        responses: [...currentResponses, newResponse]
                    });
                    alert("區塊鏈認證成功，回應已提交");
                    document.getElementById("responseInput").value = "";
                } catch (error) {
                    console.error("提交回應錯誤:", error);
                    document.getElementById("intervieweeError").innerText = `區塊鏈記錄失敗: ${error.message}`;
                }
            }

            // 初始化
            loadInterview();
            const submitButton = document.getElementById("submitResponseButton");
            if (submitButton) {
                submitButton.addEventListener("click", submitResponse);
            }

        } catch (error) {
            console.error("Firebase SDK 載入失敗:", error);
            document.getElementById("intervieweeError").innerText = `無法載入 Firebase SDK: ${error.message}`;
        }
    </script>
</body>
</html>
